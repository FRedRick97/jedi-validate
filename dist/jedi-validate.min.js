"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var s=0;s<t.length;s++){var i=t[s];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,s,i){return s&&e(t.prototype,s),i&&e(t,i),t}}(),JediValidate=function(){function e(t){var s=arguments.length<=1||void 0===arguments[1]?{}:arguments[1];_classCallCheck(this,e);var i={ajax:{dataType:"json"},sendType:"serialize",rules:{},messages:{},containers:{parent:"form-group",message:"help-block",baseMessage:"base-error"},states:{error:"error",valid:"valid"},callbacks:{success:function(){},error:function(){}}};this.root=t,this.options=Object.assign(i,s),this.fields={},this.inputs={},this.messages={},this.rules={},this._cacheNodes(),this._ready()}return _createClass(e,[{key:"_cacheNodes",value:function(){this.nodes={form:this.root.querySelector("form"),inputs:this.root.querySelectorAll("[name]"),baseMessage:this.root.querySelector("."+this.options.containers.baseMessage)}}},{key:"_ready",value:function(){var e=this;this.nodes.form.setAttribute("novalidate","novalidate"),this.nodes.form.addEventListener("submit",function(t){var s=e.checkForm();if(0!==Object.keys(s).length)return e.options.callbacks.error(s),void t.preventDefault();if(e.options.ajax){t.preventDefault();var i={};i.url=e.nodes.form.getAttribute("action"),i.method=e.nodes.form.getAttribute("method"),e._send(i)}}),this.nodes.inputs.forEach(function(t){var s=t.name;e.inputs[s]=t;var i=t.parentNode;do if(i.classList.contains(e.options.containers.parent)){e.fields[s]=i;break}while(i=i.parentNode);if(!e.fields[s])throw"Have no parent field";var r=e.fields[s].querySelector("."+e.options.containers.message);r?e.messages[s]=r:(e.messages[s]=document.createElement("div"),e.messages[s].classList.add(e.options.containers.message),e.fields[s].appendChild(e.messages[s])),e._defineRules(s),t.addEventListener("change",function(){e.checkInput(s)})})}},{key:"_send",value:function(e){var t=this,s="";this.nodes.inputs.forEach(function(e){s+=e.name+"="+encodeURIComponent(Utils.getInputValue(e))+"&"}),s=s.slice(0,-1);var i=new XMLHttpRequest;i.open(e.method,e.url+("GET"===e.method.toUpperCase()?"?"+s:""),!0),i.onreadystatechange=function(){if(4==i.readyState)if(200==i.status){var s={};try{s=JSON.parse(i.responseText)}catch(r){s.validationErrors={base:["JSON parsing error"]}}if(s.validationErrors){t.options.callbacks.error(s.validationErrors),s.validationErrors.base?(t.nodes.baseMessage.innerHTML=s.validationErrors.base.join(", "),t.root.classList.add(t.options.states.error),t.root.classList.remove(t.options.states.valid),delete s.validationErrors.base):t.nodes.baseMessage.innerHTML="";for(var a in s.validationErrors)t._markError(a,s.validationErrors[a])}else{if(t.options.callbacks.success(s),t.options.redirect&&s.redirect)return void(window.location.href=s.redirect);t.options.clean&&t.nodes.form.reset()}}else console.warn(e.method+" "+e.url+" "+i.status+" ("+i.statusText+")"),t.nodes.baseMessage.innerHTML="Can not send form!",t.root.classList.add(t.options.states.error),t.root.classList.remove(t.options.states.valid)},i.send("POST"===e.method.toUpperCase()?s:"")}},{key:"_defineRules",value:function(e){var t=this.inputs[e];this.rules[e]={};var s=["required","email","tel","url"],i=!0,r=!1,a=void 0;try{for(var n,o=s[Symbol.iterator]();!(i=(n=o.next()).done);i=!0){var l=n.value;(t.hasAttribute(l)||t.classList.contains(l))&&(this.rules[e][l]=!0)}}catch(d){r=!0,a=d}finally{try{!i&&o["return"]&&o["return"]()}finally{if(r)throw a}}t.hasAttribute("pattern")&&(this.rules[e].regexp=new RegExp(t.getAttribute("pattern"))),this.rules[e]=Object.assign(this.rules[e],this.options.rules[e]);for(var u in this.rules[e])this.rules[e][u]&&this.fields[e].classList.add(u)}},{key:"checkForm",value:function(){var e={};for(var t in this.rules){var s=this.checkInput(t);s.length&&(e[t]=s)}return e}},{key:"checkInput",value:function(t){var s=this.rules[t],i=[],r=!e.methods.required.func(Utils.getInputValue(this.inputs[t]),this.inputs[t]);if(r&&s.required)i.push(this._getErrorMessage(t));else if(!r)for(var a in s){var n=s[a];if(n)if(e.methods[a]){var o=e.methods[a].func(Utils.getInputValue(this.inputs[t]),this.inputs[t],n);o||i.push(this._getErrorMessage(t))}else i.push('Method "'+a+'" not found')}return i.length?this._markError(t,i):this._markValid(t),i}},{key:"_markError",value:function(e,t){this.fields[e]&&this.messages[e]&&(this.fields[e].classList.add(this.options.states.error),this.fields[e].classList.remove(this.options.states.valid),this.messages[e].innerHTML=t.join(", "))}},{key:"_markValid",value:function(e){this.fields[e]&&this.messages[e]&&(this.fields[e].classList.add(this.options.states.valid),this.fields[e].classList.remove(this.options.states.error),this.messages[e].innerHTML="")}},{key:"_getErrorMessage",value:function(t){var s="";return s=this.options.messages[t]&&this.options.messages[t].required?this.options.messages[t].required:e.methods.required.message}}]),e}();JediValidate.methods={},JediValidate.addMethod=function(e,t,s){JediValidate.methods[e]={func:t,message:s}},JediValidate.addMethod("required",function(e){return e&&""!==e.trim()},"Это поле необходимо заполнить"),JediValidate.addMethod("regexp",function(e,t,s){return s.test(e)},"Пожалуйста, введите корректное значение"),JediValidate.addMethod("email",function(e){return/[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i.test(e)},"Пожалуйста, введите корректный адрес электронной почты"),JediValidate.addMethod("filesize",function(e,t,s){return!t.get(0).files[0]||t.get(0).files[0].size<=s},"Попробуйте загрузить файл поменьше"),JediValidate.addMethod("extension",function(e,t,s){return!t.get(0).files[0]||s.indexOf(t.get(0).files[0].name.split(".").pop())>-1},"Пожалуйста, выберите файл с правильным расширением"),JediValidate.addMethod("tel",function(e){return/^([\+]+)*[0-9\x20\x28\x29\-]{5,20}$/.test(e)},"Не корректный номер телефона"),JediValidate.addMethod("url",function(e){return/[-a-zA-Z0-9@:%_\+.~#?&\/\/=]{2,256}\.[a-z]{2,4}\b(\/[-a-zA-Z0-9@:%_\+.~#?&\/\/=]*)?/gi.test(e)},"Не корректный url");var Utils={getInputValue:function(e){var t=null,s=e.type;if("select-one"===s)return e.options.length&&(t=e.options[e.selectedIndex].value),t;if("select-multiple"===s){t=[];for(var i=0;i<e.options.length;i++)e.options[i].selected&&t.push(e.options[i].value);return 0===t.length&&(t=null),t}return"file"===s&&"files"in e?(e.multiple?(t=Array.prototype.slice.call(e.files),0===t.length&&(t=null)):t=e.files[0],t):"checkbox"===s||"radio"===s?e.checked?e.value:null:e.value}};
//# sourceMappingURL=jedi-validate.min.js.map
